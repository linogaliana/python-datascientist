---
title: "Un cadavre exquis pour d√©couvrir Git"
date: 2020-09-30T13:00:00Z
draft: false
weight: 20
slug: exogit
tags:
  - Git
categories:
  - Exercice
  - Git
type: book
description: |
  Ce chapitre propose une mise en application de quelques principes
  centraux du langage Git vus pr√©c√©demment.
image: cadavre_exquis_kids.png
---



::: {.cell .markdown}
```{python}
#| echo: false
#| output: 'asis'
#| include: true
#| eval: true

import sys
sys.path.insert(1, '../../') #insert the utils module
from utils import print_badges

#print_badges(__file__)
print_badges("content/git/exogit.qmd")
```
:::

Les exercices suivants sont inspir√©s d'un cours de Git que j'ai
particip√© √† construire
√† l'Insee et dont les ressources sont disponibles
[ici](https://inseefrlab.github.io/formation-bonnes-pratiques-git-R/). L'id√©e
du cadavre exquis est inspir√©e de
[cette ressource](https://github.com/corent01/03-Swartz/blob/master/Parcours/01-La-prairie/git/exercice-git-cadavre-exquis.md) et de [celle-ci](https://github.com/simplonco/cadavre-request).

Cette partie part du principe que les concepts g√©n√©raux de `Git` sont
ma√Ætris√©s et qu'un environnement de travail fonctionnel avec `Git` est
disponible. Un exemple de tel environnement est le `JupyterLab` ou l'environnement `VSCode` du 
`SSPCloud` o√π une extension
`Git` est pr√©-install√©e : 

<a href="https://datalab.sspcloud.fr/launcher/ide/jupyter-python?autoLaunch=true&amp;onyxia.friendlyName=%C2%ABpython-datascience%C2%BB&amp;init.personalInit=%C2%ABhttps%3A%2F%2Fraw.githubusercontent.com%2Flinogaliana%2Fpython-datascientist%2Fmaster%2Fsspcloud%2Finit-jupyter.sh%C2%BB&amp;init.personalInitArgs=%C2%ABgit%20exogit%C2%BB&amp;security.allowlist.enabled=false" target="_blank" rel="noopener"><img src="https://img.shields.io/badge/SSPcloud-Tester%20via%20SSP--cloud-informational&amp;color=yellow?logo=Python" alt="Onyxia"></a>


Outre le [chapitre pr√©c√©dent](/content/course/git/introgit.qmd), il existe de
nombreuses ressources sur internet sur le sujet,
notamment une s√©rie de ressources construites
pour l'Insee [sur ce site](https://inseefrlab.github.io/formation-bonnes-pratiques-git-R/)
et des ressources de la documentation collaborative sur `R` qu'est `utilitR`
([des √©l√©ments sur la configuration](https://www.book.utilitr.org/03_fiches_thematiques/fiche_configurer_git)
et [pratique sur RStudio](https://www.book.utilitr.org/03_fiches_thematiques/fiche_git_utilisation)). Toutes
les ressources ne sont donc pas du `Python` car `Git` est un outil transversal
qui doit servir quel que soit le langage de pr√©dilection.

`Git` fait parti des pratiques collaboratives
devenues standards dans le domaine de l'_open-source_
mais √©galement de plus en plus communes dans les administrations et entreprises
de la _data science_. 

Ce chapitre propose, pour simplifier l'apprentissage,
d'utiliser l' extension `Git` de `JupyterLab` ou de `VSCode`.
Un tutoriel pr√©sentant l'extension `JupyterLab` est disponible
[ici](https://annefou.github.io/jupyter_publish/02-git/index.html). 
`VSCode` propose
probablement, √† l'heure actuelle, l'ensemble le plus complet. 

Certains passages de ce TD n√©cessitent d'utiliser la ligne de commande.
Il est tout √† fait possible de r√©aliser ce TD enti√®rement avec celle-ci.
Cependant, pour une personne d√©butante en `Git`, l'utilisation d'une 
interface graphique peut constituer un √©l√©ment important pour
la compr√©hension et l'adoption de `Git`. Une fois √† l'aise avec
`Git`, on peut tout √† fait se passer des interfaces graphiques
pour les routines quotidiennes et ne les utiliser que
pour certaines op√©rations o√π elles s'av√®rent fort pratiques
(notamment la comparaison de deux fichiers avant de devoir fusionner).

# Configuration du compte `Github`

## Rappels sur la notion de d√©p√¥t distant

Comme expliqu√© dans le chapitre pr√©c√©dent,
il convient de distinguer
le d√©p√¥t distant (*remote*) et la copie ou les copies locales (les *clones*)
d'un d√©p√¥t. Le d√©p√¥t distant est g√©n√©ralement stock√© sur une forge 
logicielle (`Github` ou `Gitlab`) et sert √† centraliser la version
collective d'un projet. Les copies locales sont des copies de travail.


`Git` est un syst√®me de contr√¥le de version asynchrone, c'est-√†-dire
qu'on n'interagit pas en continu avec le d√©p√¥t distant (comme c'est le
cas dans le syst√®me SVN) mais qu'il est possible d'avoir une version
locale qui se diff√©rencie du d√©p√¥t commun et qu'on rend coh√©rente
de temps en temps. 

Bien qu'il soit possible d'avoir une utilisation hors-ligne de `Git`, 
c'est-√†-dire un pur contr√¥le de version local sans d√©p√¥t
distant, cela est une utilisation
rare et qui comporte un int√©r√™t limit√©. L'int√©r√™t de `Git` est
d'offrir une mani√®re robuste et efficace d'interagir avec un 
d√©p√¥t distant facilitant ainsi la collaboration en √©quipe ou en
solitaire. 

Pour ces exercices, il est propos√©
d'utiliser `Github`, la forge la plus visible. 
L'avantage de `Github` par rapport √† son principal concurrent, `Gitlab`,
est que le premier est plus visible, car
mieux index√© par `Google` et concentre, en partie pour des raisons historiques, plus
de d√©veloppeurs `Python` et `R` (ce qui est important dans des domaines comme
le code o√π les externalit√©s de r√©seau jouent). 


[^1]: L'avantage que comportait `Gitlab` par rapport √† `Github` 
√† une √©poque, √† savoir la possibilit√© de disposer gratuitement de ressources
pour faire de l'int√©gration continue, n'existe plus depuis que `Github`
a lanc√© son service `Github Actions`. Cependant, √™tre familiaris√© √† 
l'environnement `Gitlab` reste utile car beaucoup de forges logicielles
internes reposent sur les fonctionalit√©s _open-source_ (l'interface graphique
en faisant parti) de `Gitlab`. Il est donc fort utile de ma√Ætriser 
les fonctionalit√©s coeur de ces deux interfaces qui sont en fait quasi-identiques. 


## Premi√®re √©tape: cr√©er un compte `Github`

Les deux premi√®res √©tapes se font sur [`Github`](https://github.com).

::: {.cell .markdown}
```{=html}
<div class="alert alert-success" role="alert">
<h3 class="alert-heading"><i class="fa-solid fa-pencil"></i> Exercice 1 : Cr√©er un compte <code>Github</code></h3>
```

1. Si vous n'en avez pas d√©j√† un, cr√©er un compte sur <a href="https://github.com">https://github.com</a>
2. Cr√©er un d√©p√¥t en suivant les consignes ci-dessous.

* Cr√©ez ce d√©p√¥t **priv√©**, cela permettra
dans l'exercice 2 d'activer notre jeton. Vous pourrez le rendre public
apr√®s l'exercice 2, c'est comme vous le souhaitez.
* Cr√©er ce d√©p√¥t avec un `README.md` en cliquant sur la case `Add a README file`
* Ajouter un `.gitignore` en s√©lectionnant le mod√®le `Python`

*Connexion sur <a href="https://github.com">https://github.com</a> > + (en haut de la page) > New repository > Renseigner le "Repository name" > Cocher "private" > "Create repository"*

```{=html}
</div>
```
:::

## Deuxi√®me √©tape: cr√©er un *token* (jeton) HTTPS

## Principe

`Git` est un syst√®me d√©centralis√© de contr√¥le de version :
les codes sont modifi√©s par chaque personne sur son poste de travail,
puis sont mis en conformit√© avec la version collective disponible
sur le d√©p√¥t distant au moment o√π le contributeur le d√©cide.

Il est donc n√©cessaire que la forge connaisse l‚Äôidentit√© de chacun des
contributeurs, afin de d√©terminer qui est l‚Äôauteur d‚Äôune modification apport√©e
aux codes stock√©s dans le d√©p√¥t distant.
Pour que `Github` reconnaisse un utilisateur proposant des modifications,
il est n√©cessaire de s‚Äôauthentifier (un d√©p√¥t distant, m√™me public, ne peut pas √™tre modifi√© par n‚Äôimporte qui). L‚Äôauthentification consiste ainsi √† fournir un √©l√©ment que seul vous et la forge √™tes cens√©s conna√Ætre : un mot de passe, une cl√© compliqu√©e, un jeton d‚Äôacc√®s...

Plus pr√©cis√©ment, il existe deux modalit√©s pour faire conna√Ætre son identit√© √† `Github` :

* une __authentification HTTPS__ (d√©crite ici) : l‚Äôauthentification se fait avec un login et un mot de passe ou avec un _token_ (un mot de passe compliqu√© g√©n√©r√© automatiquement par `Github` et connu exclusivement du d√©tenteur du compte `Github`)  ;
* une __authentification SSH__ : l‚Äôauthentification se fait par une cl√© crypt√©e disponible sur le poste de travail et que `GitHub` ou `GitLab` conna√Æt. Une fois configur√©e, cette m√©thode ne n√©cessite plus de faire conna√Ætre son identit√© : l‚Äôempreinte digitale que constitue la cl√© suffit √† reconna√Ætre un utilisateur.

La [documentation collaborative `utilitR`](https://www.book.utilitr.org/03_fiches_thematiques/fiche_configurer_git.html#interaction-avec-un-d%C3%A9p%C3%B4t-distant-principe) pr√©sente les raisons pour lesquelles il convient de favoriser
la m√©thode HTTPS sur la m√©thode SSH. 

::: {.cell .markdown}
```{=html}
<div class="alert alert-info" role="alert">
<h3 class="alert-heading"><i class="fa-solid fa-comment"></i> Note</h3>
```


Depuis Ao√ªt 2021, `Github` n'autorise plus l'authentification par mot de passe
lorsqu'on interagit (`pull`/`push`) avec un d√©p√¥t distant
([raisons ici](https://github.blog/changelog/2021-08-12-git-password-authentication-is-shutting-down/)).
Il est n√©cessaire d'utiliser un *token* (jeton d'acc√®s) qui pr√©sente l'avantage
d'√™tre r√©voquable (on peut √† tout moment supprimer un jeton si, par exemple,
on suspecte qu'il a √©t√© diffus√© par erreur) et √† droits limit√©s 
(le jeton permet certaines op√©rations standards mais
n'autorise pas certaines op√©rations d√©terminantes comme la suppression
d'un d√©p√¥t).

√Ä partir de mars 2023 et jusqu'√† la fin de 2023, GitHub commencera progressivement √† exiger que tous les utilisateurs de GitHub activent une ou plusieurs formes d'authentification √† deux facteurs (2FA). Pour plus d‚Äôinformations sur le d√©ploiement de l‚Äôinscription 2FA, consultez [cet article de blog](https://github.blog/2023-03-09-raising-the-bar-for-software-security-github-2fa-begins-march-13/). Concr√®tement, cela signifie que vous devrez au choix :

- Renseigner votre num√©ro de portable pour valider certaines connexions gr√¢ce √† un code que vous recevrez par sms ;
- Installer une application d'authentification (Ex : Microsoft Authenticator) install√©e sur votre t√©l√©phone qui g√©n√®rera un QR code que vous pourrez scanner depuis github, ce qui ne n√©cessite pas que vous ayez √† fournir votre num√©ro de t√©l√©phone
- Utiliser une clef USB de s√©curit√© 

Pour choisir entre ces diff√©rentes options, vous pouvez vous rendre sur *Settings > Password and authentication > Enable two-factor authentication*.


```{=html}
</div>
```
:::


::: {.cell .markdown}
```{=html}
<div class="alert alert-info" role="alert">
<h3 class="alert-heading"><i class="fa-solid fa-comment"></i> Note</h3>
```

Il est important de ne jamais stocker un _token_, et encore moins son mot de passe, dans un projet.
Il est possible de stocker un mot de passe ou *token* de mani√®re s√©curis√©e et durable
avec le *credential helper* de `Git`. Celui-ci est pr√©sent√© par la suite.

S'il n'est pas possible d'utiliser le *credential helper* de `Git`, un mot de passe 
ou _token_ peut √™tre stock√© de mani√®re s√©curis√© dans
un syst√®me de gestion de mot de passe comme [Keepass](https://keepass.fr/).

Ne jamais stocker un jeton `Github`, ou pire un mot de passe, dans un fichier
texte non crypt√©. Les logiciels de gestion de mot de passe
(comme [Keepass](https://keepass.fr/), recommand√© par l'Anssi)
sont simples
d'usage et permettent de ne conserver sur l'ordinateur qu'une version
hash√©e du mot de passe qui ne peut √™tre d√©crypt√©e qu'avec un mot de passe
connu de vous seuls. 

```{=html}
</div>
```
:::


## Cr√©er un jeton

La [documentation officielle](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token) comporte un certain nombre de captures d'√©cran expliquant
comment proc√©der.

Nous allons utiliser le `credential helper` associ√© √† `Git` pour stocker
ce jeton. Ce `credential helper` permet de conserver de mani√®re p√©renne
un jeton (on peut aussi faire en sorte que le mot de passe soit automatiquement
supprim√© de la m√©moire de l'ordinateur au bout, par 
exemple, d'une heure). 

L'inconv√©nient de cette m√©thode est que `Git` √©crit en clair le jeton dans
un fichier de configuration. C'est pour cette raison qu'on utilise des jetons
puisque, si ces derniers sont r√©v√©l√©s, on peut toujours les r√©voquer et √©viter
les probl√®mes (pour ne pas stocker en clair un jeton il faudrait utiliser
une librairie suppl√©mentaire comme `libsecrets` qui est au-del√† du programme
de ce cours).

Si vous d√©sirez conserver de mani√®re plus durable ou plus s√©curis√©e votre jeton
(en ne conservant pas le jeton en clair mais de mani√®re hash√©e),
est d'utiliser un gestionnaire de mot de passe comme 
[Keepass](https://keepass.fr/) (recommand√© par l'Anssi). N√©anmoins,
il est recommand√© de tout de m√™me fixer une date d'exp√©ritation
aux jetons pour limiter les risques de s√©curit√© d'un _token_ qui fuite
sans s'en rendre compte.

::: {.cell .markdown}
```{=html}
<div class="alert alert-success" role="alert">
<h3 class="alert-heading"><i class="fa-solid fa-pencil"></i> Exercice 2.0 : Cr√©er un service sur le SSPCloud</h3>
```

En amont de l'exercice 2, pour les utilisateurs
du `SSPCloud`,
il est recommand√© d'ouvrir un service `Jupyter`
en suivant les consignes suivantes :

* Dans la page `Mes services`, cliquer sur le bouton `Nouveau service` ;
* Choisir `Jupyter-Python` ;
* Cliquer sur `Configuration Jupyter-Python`. ‚ö†Ô∏è ne pas lancer le service
tout de suite !
* Faire d√©filer les onglets pour arriver sur l'onglet `Git` ;
* Remplacer la valeur sous `Cache` par un nombre important,
par exemple `36000` pour que le jeton que vous utiliserez soit
valable 10 heures ;
* Lancer le service.

```{=html}
</div>
```
:::



::: {.cell .markdown}
```{=html}
<div class="alert alert-success" role="alert">
<h3 class="alert-heading"><i class="fa-solid fa-pencil"></i> Exercice 2 : Cr√©er et stocker un token</h3>
```

1Ô∏è‚É£ Suivre la
[documentation officielle](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token) en ne donnant que les droits `repo` au jeton (ajouter les droits
`workflow` si vous d√©sirez que votre jeton soit utilisable pour des projets
o√π l'int√©gration continue est n√©cessaire).

Pour r√©sumer les √©tapes devraient √™tre les suivantes :

*Settings > Developers Settings > Personal Access Token > Generate a new token > "My bash script" > Expiration "30 days" > cocher juste "repo" > Generate token > Le copier*


2Ô∏è‚É£ Ouvrir un terminal depuis `Jupyter` (par exemple `File > New > Terminal`) ou `VSCode` (`Terminal > New Terminal`).

3Ô∏è‚É£ [Optionnel] Taper dans le terminal la commande 
qui convient selon votre syst√®me d'exploitation pour activer le
`credential helper`:

```shell
# Sous mac et linux et le datalab
git config --global credential.helper store

# Sous windows
git config --global credential.helper manager-core
```

4Ô∏è‚É£ R√©cup√©rer, sur la page d'accueil de votre d√©p√¥t, l'url du d√©p√¥t distant.
Il prend la forme suivante

`https://github.com/<username>/<reponame>.git`

Vous pouvez utiliser l'icone √† droite pour copier l'url.

5Ô∏è‚É£ Retournez dans le Terminal. Taper 

```shell
git clone repo_url
```

o√π `repo_url` est l'url du d√©p√¥t en question (vous pouvez utiliser
<kbd>MAJ</kbd>+<kbd>Inser</kbd> pour coller l'url pr√©c√©demment copi√©)

Tapez <kbd>Entr√©e</kbd>. Dans le cas d'un r√©pertoire priv√© et sans credential helper, renseignez ensuite votre identifiant, faites <kbd>Entr√©e</kbd>, puis votre personal access token, <kbd>Entr√©e</kbd>. Si vous n'avez pas d'erreur, cela signifie
que l'authentification a bien fonctionn√© et donc que tout va
bien. Sinon, il vous suffit de r√©√©crire l'instruction `git clone` et de retenter de taper votre personal access token. Normalement, si vous avez cr√©√© un d√©p√¥t vide dans l'exercice 1,
vous avez un message de `Git`: 

> warning: You appear to have cloned an empty repository.

Ce n'est pas une erreur mais il est pr√©f√©rable de suivre la
consigne de l'exercice 1 et de cr√©er un projet non vide.
Le dossier de votre projet a bien
√©t√© cr√©√©.

Si vous avez une erreur, suivez la consigne pr√©sent√©e ci-apr√®s
pour r√©initialiser
votre *credential helper*

6Ô∏è‚É£ Si vous le d√©sirez, vous pouvez changer la visibilit√© de votre d√©p√¥t
en le rendant public. 

[^3]: Comme le cr√©ateur de `Git` √©tait un peu paranoiaque, il est normal de ne pas voir le curseur avancer quand on tape des caract√®res pour le mot de passe, si quelqu'un regarde votre √©cran il ne pourra ainsi pas savoir combien de caract√®res comporte votre mot de passe.

7Ô∏è‚É£ Stocker le token sur le SSP Cloud (ou un gestionnaire de mot de passe) :

> Mon Compte -> Services externes -> Jeton d'acc√®s personnel GitHub


```{=html}
</div>
```
:::


::: {.cell .markdown}
```{=html}
<div class="alert alert-info" role="alert">
<h3 class="alert-heading"><i class="fa-solid fa-comment"></i> Note</h3>
```

Si vous avez fait une faute de frappe dans le mot de passe ou dans le jeton, il est possible de vider la m√©moire
de la mani√®re suivante, sous Mac ou Linux :

~~~~shell
git config --global --unset credential.helper
~~~~

Sous Windows, si vous avez utilis√© l'option `manager-core` √©voqu√©e ci-dessus, vous pouvez utiliser une interface graphique pour effacer le mot de passe ou jeton erron√©. Pour cela, dans le menu d√©marrer, taper `Gestionnaire d'identification` (ou `Credential Manager` si Windows ne trouve pas). Dans l'interface graphique qui s'ouvre, il est possible de supprimer le mot de passe ou jeton en question. Apr√®s cela, vous devriez √† nouveau avoir l'opportunit√© de taper un mot de passe ou jeton lors d'une authentification HTTPS.

```{=html}
</div>
```
:::

# Premier commit

A ce stade, nous avons configur√© `Git` pour √™tre en mesure 
de s'authentifier automatiquement et nous avons clon√© le d√©p√¥t pour avoir une
copie locale de travail. 

On n'a encore ajout√© aucun fichier √† `Git` en suppl√©ment
de ceux cr√©√©s en m√™me temps que le d√©p√¥t. Nous allons
cr√©er ces premiers fichiers


::: {.cell .markdown}
```{=html}
<div class="alert alert-success" role="alert">
<h3 class="alert-heading"><i class="fa-solid fa-pencil"></i> Exercice 3 : Indexer des modifications</h3>
```

1. Cr√©er un dossier üìÅ `scripts` depuis l'interface de `Jupyter`
2. Y cr√©er les fichiers `script1.py` et `script2.py`, chacun contenant quelques commandes `Python` de votre choix (le contenu de ces fichiers n'est pas important).

Sur la session `Jupyter` d'`Onyxia`, si le `Clic Droit > rename` ne fonctionne pas, vous pouvez faire : `File > New > Text file` apr√®s vous √™tre assur√©s que vous vous situez bien dans le dossier <nom_du_projet> de l'arborescence. Un fichier `untitled.txt` se cr√©e. Vous pouvez le renommer,
en n'oubliant pas de changer l'extension en `.py`.

3. Se rendre dans l'extension `Git` de `Jupyter` ou de `VSCode`. Vous devriez
retrouver un cadre ayant cet aspect (√† gauche pour `Jupyter` et √† droite pour `VSCode`).

::: {#fig-status layout-ncol=2}

![](git-status-ensae.png)

![](git_vscode_1.png)

Interface graphique Git sous Jupyter (√† gauche) et VSCode (√† droite)
:::

En ligne de commande, c'est l'√©quivalent de 

```shell
git status
```

2. Sur `Jupyter`, en passant votre souris au dessus du nom des fichiers `script1.py` et
`script2.py`, vous devriez voir
un `+` appara√Ætre. Cliquez dessus. Sur `VSCode`, un bouton `+` figure √† droite du nom
du fichier `.script1.py` et
`.script2.py`.

Si vous aviez privil√©gi√© la ligne de commande, ce que vous avez fait est √©quivalent √† :

~~~shell
git add scripts/script1.py
git add scripts/script2.py
~~~

Pour se rem√©morer ce que signifie `git add`, vous pouvez vous rendre
sur [ce cours d√©di√© √† `Git`](https://inseefrlab.github.io/formation-bonnes-pratiques-git-R/).

3. Observer le changement de statut du fichier apr√®s avoir cliqu√© sur `+`. Il est
d√©sormais dans la partie `Staged`
En gros, vous venez de dire √† Git que vous allez rendre publique une √©volution
du fichier, mais vous ne l'avez pas encore fait (`Staged` est une liste d'attente).

Si vous √©tiez en ligne de commande vous auriez ce r√©sultat apr√®s un `git status`

```raw
On branch main

No commits yet

Changes to be committed:
  (use "git rm --cached <file>..." to unstage)
        new file:   .gitignore
```


Les nouvelles modifications (en
l'occurrence la cr√©ation du fichier et la validation de son contenu actuel)
ne sont pas encore archiv√©es. Pour cela, il va falloir faire un 
`commit` (on rend publique une modification)

4. Avant cela, regardons les modifications qu'on va prochainement
valider. Pour cela, passez la souris au dessus du nom du fichier
`.gitignore` et cliquer sur le bouton `Diff this file` (+ -).
Une page s'ouvre et met en regard la version ant√©rieure avec
les ajouts en vert et les suppressions en rouge. Nous retrouverons
cette visualisation avec l'interface `Github`, plus tard. 

En l'occurrence, comme le fichier n'existait pas, normalement nous n'avons que
des ajouts.

Il est √©galement possible d'effectuer cela avec la ligne de commande mais c'est
beaucoup moins pratique. Pour cela, la commande √† appeler est `git diff` et
il est n√©cessaire d'utiliser l'option `cached` pour lui dire d'inspecter les
fichiers pour lesquels on n'a pas encore effectu√© de `commit`. En vert
appara√Ætront les modifications et en rouge les suppressions mais, cette fois,
les r√©sultats ne seront pas mis c√¥te-√†-c√¥te ce qui est beaucoup moins
pratique.

```shell
git diff --cached
```

```{=html}
</div>
```
:::

Il est temps de valider notre modification. Cette op√©ration
s'appelle `commit` en langage `Git` et, comme son nom l'indique, il 
s'agit d'une proposition de modification sur laquelle, en quelques
sortes, on s'engage. 

Un _commit_ comporte un titre et √©ventuellement une description. A ces
informations, `Git` ajoutera automatiquement quelques √©l√©ments
suppl√©mentaires, notamment l'auteur du commit (pour identifier la personne
ayant propos√© cette modification) et l'horodatage (pour identifier le moment
o√π cette modification a √©t√© propos√©e). Ces informations permettront d'identifier
de mani√®re unique le `commit` auquel sera ajout√© un identifiant al√©atoire
unique (un num√©ro SHA) qui permettra de faire r√©f√©rence √† celui-ci sans
ambigu√Øt√©.

Le titre est important car il s'agit, pour un humain, du point d'entr√©e
dans l'histoire d'un d√©p√¥t (voir par exemple
[l'histoire du d√©p√¥t du cours](https://github.com/linogaliana/python-datascientist/commits/master).
Les titres vagues 
(*Mise √† jour du fichier*, *Update*...) sont √† bannir car ils
n√©cessiteront un effort inutile pour comprendre les fichiers modifi√©s.

N'oubliez pas que votre premier collaborateur est votre *moi futur* qui,
dans quelques semaines, ne se souviendra pas en quoi consistait
le commit *Update* du 12 janvier et en quoi il se distingue du 
*Update* du 13 mars. 



::: {.cell .markdown}
```{=html}
<div class="alert alert-success" role="alert">
<h3 class="alert-heading"><i class="fa-solid fa-pencil"></i> Exercice 4 : Premier commit (enfin !)</h3>
```

Sur `Jupyter`, tout se passe dans la partie inf√©rieure de l'interface graphique.

![](git-panel-jupyter.png)

Sur `VSCode`, il faut au contraire regarder en haut.

![](git_vscode_2.png)

1Ô∏è‚É£ Entrer le titre `Initial commit` et ajouter une description
`Cr√©ation des premiers fichiers üéâ`.
Sur `VSCode`, le titre du commit correspond √† la
premi√®re ligne du message de commit, les lignes suivantes correspondent √† la
description.



Le fait de nommer le premier commit *"Initial commit"* est une
habitude, vous
n'√™tes pas oblig√© de suivre cette convention si elle ne vous pla√Æt pas.

2Ô∏è‚É£ Cliquer sur `Commit`. Le fichier a disparu de la liste, c'est normal,
il n'a plus de modification √† valider. Pour le retrouver dans la liste
des fichiers `Changed`, il faudra le modifier √† nouveau

3Ô∏è‚É£ Sur `Jupyter`, cliquer sur l'onglet `History` ou sur `VSCode` cliquer 
sur l'ic√¥ne `View Git Graph`. Votre `commit` appara√Æt √† ce niveau.
Si vous cliquez dessus, vous obtenez des informations sur le `commit`.

```{=html}
</div>
```
:::

‚ùì Question : √† ce stade, le d√©p√¥t du projet sur `GitHub` (_remote_) a-t-il √©t√© modifi√© ?


::: {.cell .markdown}
```{=html}
<div class="alert alert-info" role="alert">
<h3 class="alert-heading"><i class="fa-solid fa-comment"></i> Note</h3>
```

Si vous utilisiez la ligne de commande, la mani√®re √©quivalente de faire
serait

~~~shell
git commit -m "Initial commit" -m "Cr√©ation des premiers fichiers üéâ"
~~~

L'option `m` permet de cr√©er un message, qui sera disponible √† l'ensemble
des contributeurs du projet. Avec la ligne de commande, ce n'est pas toujours
tr√®s pratique. Les interfaces graphiques permettent des messages plus
d√©velopp√©s (la bonne pratique veut qu'on √©crive un message de commit comme un
mail succinct : un titre et un peu d'explications, si besoin).

```{=html}
</div>
```
:::



# Le fichier `.gitignore`



Lorsqu'on utilise `Git`, il y a des fichiers qu'on ne veut pas partager
ou dont on ne veut pas suivre les modifications (typiquement les grosses bases de donn√©es).

C'est le fichier `.gitignore`
qui g√®re les fichiers exclus du contr√¥le de version.
Lors de la cr√©ation du projet sur `GitHub`, nous avons demand√© la cr√©ation d'un fichier `.gitignore`, qui se situe √† la racine du projet. Il sp√©cifie l'ensemble des fichiers qui seront toujours exclus de l'indexation faite par `Git`.

::: {.cell .markdown}
```{=html}
<div class="alert alert-success" role="alert">
<h3 class="alert-heading"><i class="fa-solid fa-pencil"></i> Exercice 5 : Le fichier <code>.gitignore</code></h3>
```

1Ô∏è‚É£ Par d√©faut, le fichier `.gitignore` n'est pas affich√© car
les fichiers `.*` sont des fichiers de configuration. Il faut activer
une option pour l'afficher. Tout en haut
de `Jupyter`, cliquer sur `View -> Show Hidden Files`

2Ô∏è‚É£ Ouvrir ce fichier maintenant qu'il s'affiche et observer
quelques r√®gles √©crites dedans

3Ô∏è‚É£ Cr√©er un dossier `data` √† la racine du projet et cr√©er √† l'int√©rieur de celui-ci un fichier `data/raw.csv` avec une ligne de donn√©es quelconque

4Ô∏è‚É£ Ajouter au `.gitignore` le dossier `data/`

5Ô∏è‚É£ V√©rifier que toutes les r√®gles ajout√©es pr√©c√©demment fonctionnent comme attendu

```{=html}
</div>
```
:::

‚ùì **Question** : que se passe-t-il lorsque l'on ajoute au `.gitignore` des fichiers qui ont d√©j√† √©t√© *commit* sur le projet Git ?


# Premi√®res interactions avec `Github` depuis sa copie de travail

Jusqu'√† pr√©sent, apr√®s avoir clon√© le d√©p√¥t, on a travaill√© uniquement
sur notre copie locale. On n'a pas cherch√© √† interagir √† nouveau 
avec `Github`. 

Cependant, il existe bien une connexion entre notre dossier local et
le d√©p√¥t `Github`. Si on utilise la ligne de commande,
on peut s'en assurer en tapant dans un terminal

~~~shell
git remote -v
~~~

Le d√©p√¥t distant s'appelle `remote` en langage Git. L'option `-v` (*verbose*)
permet de lister le(s) d√©p√¥t(s) distant(s). Le r√©sultat devrait avoir la
structure suivante :

```raw
origin  https://github.com/<username>/<projectname>.git (fetch)
origin  https://github.com/<username>/<projectname>.git (push)
```

Plusieurs informations sont int√©ressantes dans ce r√©sultat. D'abord on 
retrouve bien l'url qu'on avait renseign√© √† `Git` lors de l'op√©ration
de clonage. Ensuite, on remarque un terme `origin`. C'est un alias
pour l'url qui suit. Cela √©vite d'avoir, √† chaque fois, √† taper l'ensemble
de l'url, ce qui peut √™tre p√©nible et source d'erreur.

`fetch` et `push`
sont l√† pour nous indiquer qu'on r√©cup√®re (`fetch`) des modifications
d'`origin` mais qu'on envoie √©galement (`push`) des modifications vers
celui-ci. G√©n√©ralement, les url de ces deux d√©p√¥ts sont les m√™mes mais cela peut
arriver, lorsqu'on contribue √† des projets opensource qu'on n'a pas cr√©√©, 
qu'ils diff√®rent[^2].

[^2]: Ce cas de figure arrive lorsqu'on contribue √† des projets
sur lesquels on n'a pas de droit d'√©criture. Il est alors
n√©cessaire d'effectuer un _fork_, une copie de ce d√©p√¥t sur laquelle
on dispose de droits. 
Dans ce cas de figure, on rencontre g√©n√©ralement un nouvel alias √† c√¥t√© d'`origin`. 
nomm√© `upstream` (cf.
[le tutoriel `Github` pour mettre √† jour un _fork_](https://docs.github.com/en/github/collaborating-with-pull-requests/working-with-forks/syncing-a-fork)
et qui pointe vers le d√©p√¥t source √† l'origine du _fork_. 
La cr√©ation du bouton `Fetch upstream` par `Github` facilite grandement
la mise en coh√©rence d'`upstream` et `origin` et constitue la m√©thode
recommand√©e. 

## Envoyer des modifications sur le d√©p√¥t distant: `push`

::: {.cell .markdown}
```{=html}
<div class="alert alert-success" role="alert">
<h3 class="alert-heading"><i class="fa-solid fa-pencil"></i> Exercice 6 : Interagir avec <code>Github</code></h3>
```


Il convient maintenant d'envoyer les fichiers sur le d√©p√¥t distant. 

<!----
A voir si on va pas devoir faire √ßa plus tard

1. R√©cup√©rer l'url du d√©p√¥t. Dans `Github`, il faut cliquer sur
le bouton `Code` comme ci-dessous

![](gitclone.png)

2. Cr√©er la connexion avec le d√©p√¥t distant (`remote`), qu'on va nommer `origin`,
en utilisant la commande suivante :

~~~~shell
git remote add origin ****
~~~~
Remplacer les ast√©risques par l'url du d√©p√¥t. 
---->

1Ô∏è‚É£
L'objectif est d'envoyer vos modifications vers `origin`. 
On va passer par la ligne de commande car les boutons `push`/`pull`
de l'extension `Jupyter` ne fonctionnent pas de mani√®re syst√©matique. 

Taper

~~~~shell
git push origin main
~~~~

Cela signifie: *"git envoie (`push`) mes modifications sur la 
branche `main` (la branche sur laquelle on a travaill√©, on reviendra
dessus) vers mon d√©p√¥t (alias
`origin`)"*

*Remarque : Si vous obtenez l'erreur suivante `error: src refspec hello does not match any`, c'est probablement que vous avez indiqu√© le mauvais nom de branche. La confusion se fait souvent entre le nom `main` ou `master` (ancienne norme de branche par d√©faut).*

Normalement, si vous avez utilis√© le `credential helper`, `Git` ne 
vous demande pas vos identifiants de connexion. Sinon, 
il faut taper
votre identifiant Github et **votre mot de passe correspond au personal access token nouvellement cr√©√©** ! 


2Ô∏è‚É£ Retournez voir le d√©p√¥t sur `Github`, vous devriez maintenant voir le fichier
`.gitignore` s'afficher en page d'accueil. 

```{=html}
</div>
```
:::

## La fonctionnalit√© `pull`

La deuxi√®me mani√®re d'interagir avec le d√©p√¥t est de r√©cup√©rer des
r√©sultats disponibles en ligne sur sa copie de travail. On appelle
cela `pull`. 

Pour le moment, vous √™tes tout seul sur le d√©p√¥t. Il n'y a donc pas de 
partenaire pour modifier un fichier dans le d√©p√¥t distant. On va simuler ce
cas en utilisant l'interface graphique de `Github` pour modifier
des fichiers. On rapatriera les r√©sultats en local dans un deuxi√®me temps. 

::: {.cell .markdown}
```{=html}
<div class="alert alert-success" role="alert">
<h3 class="alert-heading"><i class="fa-solid fa-pencil"></i> Exercice 7 : Rapatrier des modifs en local</h3>
```

1Ô∏è‚É£ Se rendre sur votre d√©p√¥t depuis l'interface <https://github.com>

* Se placer sur le fichier `README.md` et cliquer sur le bouton `Edit this file`, qui prend la forme d'un ic√¥ne de crayon.

2Ô∏è‚É£ L'objectif est de
donner au `README.md` un titre en ajoutant, au d√©but du document, la ligne suivante : 

```{python}
#| output: asis
#| echo: false
print(
"""~~~markdown
# Mon oeuvre d'art surr√©aliste 
~~~""")
```

Sautez une ligne et entrez le texte que vous d√©sirez, sans ponctuation. Par exemple,

~~~markdown
le ch√™ne un jour dit au roseau
~~~

3Ô∏è‚É£ Cliquez sur l'onglet `Preview` pour voir le texte mis en forme au format `Markdown`

4Ô∏è‚É£  R√©diger un titre et un message compl√©mentaire pour faire le `commit`. Conserver
l'option par d√©faut `Commit directly to the main branch`

5Ô∏è‚É£ Editer √† nouveau le `README` en cliquant sur le crayon juste au dessus
de l'affichage du contenu du `README`.

Ajouter une deuxi√®me phrase et corrigez la
ponctuation de la premi√®re. Ecrire un message de commit et valider.

~~~markdown
Le Ch√™ne un jour dit au roseau :
Vous avez bien sujet d'accuser la Nature
~~~

6Ô∏è‚É£ Au dessus de l'aborescence des fichiers, vous devriez voir s'afficher le
titre du dernier commit. Vous pouvez cliquer dessus pour voir la modification
que vous avez faite.

7Ô∏è‚É£ Les r√©sultats sont sur le d√©p√¥t distant mais ne sont pas sur votre
dossier de travail dans `Jupyter` ou `VSCode`. Il faut re-synchroniser votre copie locale
avec le d√©p√¥t distant :

* Sur `VSCode`, cliquez simplement sur `... > Pull` √† c√¥t√© du bouton qui permet
de visualiser le graphe Git.
* Avec l'interface `Jupyter`, si cela est possible, appuyez tout simplement sur la petite
fl√®che vers le bas, qui est celle qui a d√©sormais la pastille orange.
* Si cette fl√®che n'est pas disponible ou si vous travaillez dans un autre
environnement, vous pouvez utiliser la ligne de 
commande et taper

~~~shell
git pull origin main
~~~

Cela signifie : *"git r√©cup√®re (`pull`) les modifications sur la 
branche `main` vers mon d√©p√¥t (alias
`origin`)"*

8Ô∏è‚É£ Regarder √† nouveau l'historique des commits. Cliquez sur le
dernier commit et affichez les changements sur le fichier. Vous pouvez
remarquer la finesse du contr√¥le de version : `Git` d√©tecte au sein de
la premi√®re ligne de votre texte que vous avez mis des majuscules
ou de la ponctuation. 

```{=html}
</div>
```
:::

L'op√©ration `pull` permet : 

1. A votre syst√®me local de v√©rifier les modifications sur le d√©p√¥t distant
que vous n'auriez pas faites (cette op√©ration s'appelle `fetch`)
2. De les fusionner s'il n'y a pas de conflit de version ou si les conflits de
version sont automatiquement fusionnables (deux modifications d'un fichier mais
qui ne portent pas sur le m√™me emplacement).


# M√™me tout seul, ne pas se limiter √† `main`


Au d√©but d‚Äôune t√¢che particuli√®re ou d‚Äôun projet, il est recommand√© d‚Äôouvrir des *issues*. Prenant la forme d‚Äôun espace de discussion, elles correpondront √† la fin √† des nouvelles fonctionnalit√©s (en anglais, *features*). Les issues permettent √©galement de signaler des bugs constat√©s, de se les r√©partir et d‚Äôindiquer s‚Äôils sont r√©gl√©s ou s‚Äôils ont avanc√©s. Une utilisation intensive des *issues*, avec des labels ad√©quats, peut
m√™me amener √† se passer d'outils de gestion de projets comme `Trello`. 


La branche `main` est la branche principale. Elle se doit d'√™tre "propre". Si on veut √™tre rigoureux, on ne pousse pas des travaux non aboutis sur `main`.  

Il est possible de pousser directement sur `main` dans le cas de petites corrections, de modifications mineures dont vous √™tes certains qu'elles vont fonctionner. Mais sachez que dans le cadre de projets sensibles, c'est strictement interdit. N'ayez pas peur de fixer comme r√®gle l'interdiction de pousser sur `main`, cela obligera l'√©quipe projet √† travailler professionnellement. 

Au moindre doute, cr√©ez une branche. Les branches sont utilis√©es pour des travaux significatifs :

- vous travaillez seul sur une t√¢che qui va vous prendre plusieurs heures ou jours de travail (vous ne devez pas pousser sur `main` des travaux non aboutis);
- vous travaillez sur une fonctionnalit√© nouvelle et vous souhaiterez recueillir l'avis de vos collaborateurs avant de modifier `main`;
- vous n'√™tes pas certain de r√©ussir vos modifications du premier coup et pr√©f√©rez faire des tests en parall√®le.


::: {.cell .markdown}
```{=html}
<div class="alert alert-danger" role="alert">
<i class="fa-solid fa-triangle-exclamation"></i> Warning</h3>
```

Les branches ne sont pas personnelles : **Toutes les branches sont publi√©es, le `rebase` est interdit. Le push force est √©galement interdit.**

Il faut **absolument** bannir les usages de `push force` qui peuvent d√©stabiliser les copies locales des collaborateurs. S'il est n√©cessaire de faire un `push force`, c'est qu'il y a un probl√®me dans la branche, √† identifier et r√©gler **sans** faire `push force`.

![](https://miro.medium.com/max/400/0*XaLzNzYkA6PZjbl9.jpg)

**Tous les merges dans `main` doivent se faire par l'interm√©diaire d'une `pull request` dans `Github`**. En effet, il est tr√®s d√©conseill√© de merger une branche dans main localement.

```{=html}
</div>
```
:::


::: {.cell .markdown}
```{=html}
<div class="alert alert-success" role="alert">
<h3 class="alert-heading"><i class="fa-solid fa-pencil"></i> Exercice 8: Cr√©er une nouvelle branche et l'int√©grer dans main</h3>
```


1Ô∏è‚É£ Ouvrir une *issue* sur `Github`. Signaler qu'il serait bien d'ajouter un emoji chat dans le README. Dans la partie de droite, cliquer sur la petite roue √† c√¥t√© de `Label` et cliquer sur `Edit Labels`. Cr√©er un label `Markdown`. Normalement, le label a √©t√© ajout√©.

2Ô∏è‚É£ Retournez sur votre d√©p√¥t local. Vous allez cr√©er une branche nomm√©e
`issue-1`

Avec l'interface graphique de JupyterLab, cliquez sur `Current Branch - Main`
puis sur le bouton `New Branch`. Rentrez `issue-1` comme nom de branche
(la branche doit √™tre cr√©√©e depuis `main`, ce qui est normalement le choix
par d√©faut) et cliquez sur `Create Branch`.

Sur VSCode, cliquez sur `... > Branch > Create Branch` et entrez le nom `issue-1`.

Si vous n'utilisez pas l'interface graphique mais la ligne de commande, la
mani√®re √©quivalente de faire est[^4]

~~~shell
git checkout -b issue-1
~~~~

[^4]: La commande `checkout` est un couteau-suisse de la gestion de branche en `Git`. Elle permet en effet de basculer d'une branche √† l'autre, mais aussi d'en cr√©er, etc. 


3Ô∏è‚É£ Ouvrez `README.md` et ajoutez un emoji chat (`:cat:`) √† la suite du titre.
Faites un commit en refaisant les √©tapes vues dans les exercices
pr√©c√©dents. N'oubliez pas, cela se fait en deux √©tapes:

1. Ajoute les modifications √† l'index en d√©placant le fichier `README` dans
la partie `Staged`
2. Validation des modifications avec un `commit`

Si vous passez par la ligne de commande, cela donnera :

~~~shell
git add .
git commit -m "ajout emoji chat"
~~~


4Ô∏è‚É£ Faire un **deuxi√®me commit** pour ajouter un emoji koala (:koala:) puis
pousser les modifications locales.

Cela peut √™tre fait avec l'interface
de `JupyterLab` gr√¢ce au bouton avec une fl√™che montante (il doit appara√Ætre
en orange maintenant). Sur `VSCode`, cliquez sur le bouton `Publish Branch`.

Sinon, si vous utilisez la ligne de commande, vous devrez taper

~~~shell
git push origin issue-1
~~~~

5Ô∏è‚É£ Dans `Github`, devrait appara√Ætre 

> `issue-1 had recent pushes XX minutes ago`. 

Cliquer sur `Compare & Pull Request`. Donner un titre informatif √† votre *pull request* 
Dans le message en dessous, taper

> `- close #1`

Le tiret est une petite astuce pour que `Github` 
remplace le num√©ro de l'issue par le titre.

Cliquez sur `Create Pull Request` mais 
**ne validez pas la fusion**, on le fera dans un second temps.

Le fait d'avoir mis un message `close` suivi d'un num√©ro d'issue `#1`
permettra de fermer automatiquement l'*issue 1* lorsque vous ferez le *merge*.
En attendant, vous avez cr√©√© un lien entre l'*issue* et la *pull request*

Au passage, vous pouvez ajouter le label `Markdown` sur la droite. 

6Ô∏è‚É£ En local, retourner sur `main`. Dans l'interface `Jupyter`, il suffit
de cliquer sur `main` dans la liste des branches. Sur `VSCode`, la liste des branches
appara√Æt en cliquant sur le nom de la branche actuelle (`issue-1` en th√©orie √† ce stade).
Si vous √™tes en ligne de commande, il faut faire

~~~shell
git checkout main
~~~~

`checkout` est une commande `Git` qui permet de naviguer d'une branche √† l'autre
(voire d'un commit √† l'autre). 

Ajouter une phrase √† la suite de votre texte dans le `README.md` 
(ne touchez pas au titre !). Vous pouvez remarquer que les emojis
ne sont pas dans le titre, c'est normal vous n'avez pas encore fusionn√© les versions

7Ô∏è‚É£ Faire un commit et un push. En ligne de commande, cela donne

~~~shell
git add .
git commit -m "ajoute un troisi√®me vers"
git push origin main
~~~


8Ô∏è‚É£ Sur `Github`, cliquer sur `Insights` en haut du d√©p√¥t puis, √† gauche sur `Network` (cela n'est
possible que si vous avez rendu public votre d√©p√¥t).

Vous devriez voir appara√Ætre l'arborescence de votre d√©p√¥t. On peut voir `issue-1` comme une ramification et `main` comme le tronc.

L'objectif est maintenant de ramener les modifications faites dans `issue-1` dans la branche principale. Retournez dans l'onglet `Pull Requests`. L√†, changer le type de `merge` pour `Squash and Merge`, comme ci-dessous (petit conseil : choisissez toujours cette m√©thode de *merge*).

Une fois que cela est fait, vous pouvez retourner dans `Insights` puis `Network` pour v√©rifier que tout s'est bien pass√© comme pr√©vu. 


![](squashmerge.png)


9Ô∏è‚É£ Supprimer la branche (*branch > delete this branch*). Puisqu'elle est merg√©e, elle ne servira plus. La conserver risque d'amener √† des `push` involontaires dessus. 

```{=html}
</div>
```
:::


L'option de fusion *Squash and Merge* permet de regrouper tous les commits d'une branche (potentiellement tr√®s nombreux) en un seul dans la branche de destination. Cela √©vite, sur les gros projets, des branches avec des milliers de *commits*.

Je recommande de toujours utiliser cette technique et non les autres. 
Pour d√©sactiver les autres techniques, vous pouvez aller dans
`Settings` et dans la partie `Merge button` ne conserver coch√©e que la
m√©thode `Allow squash merging`


# Un cadavre exquis pour d√©couvrir le travail collaboratif

Jusqu'√† pr√©sent, nous avons d√©couvert les vertus de `Git` dans un projet
individuel. Nous allons maintenant aller plus loin dans un projet 
collectif. 

## Le *workflow* adopt√©

Nous allons adopter le mode de travail le plus simple, le *Github Flow*. 
Il correspond √† cette forme caract√©ristique d'arbre:

1. La branche `main` constitue le tronc
2. Les branches partent de `main` et divergent
3. Lorsque les modifications aboutissent, elles sont int√©gr√©es √† `main` ; 
la branche en question dispara√Æt :

![](https://inseefrlab.github.io/formation-bonnes-pratiques-git-R/slides/img/ghflow.png)


Il existe des *workflows* plus complexes, notamment le `Git Flow` que j'utilise
pour d√©velopper ce cours. [Ce tutoriel](https://www.atlassian.com/fr/git/tutorials/comparing-workflows/gitflow-workflow), tr√®s bien fait, 
illustre avec un graphique la complexit√© accrue de ce flow : 

![](https://wac-cdn.atlassian.com/dam/jcr:8f00f1a4-ef2d-498a-a2c6-8020bb97902f/03%20Release%20branches.svg?cdnVersion=55)

Cette fois, une branche interm√©diaire, par exemple une branche `development`
int√®gre des modifications √† tester avant de les int√©grer dans la version 
officielle (`main`).

::: {.cell .markdown}
```{=html}
<div class="alert alert-warning" role="alert">
<h3 class="alert-heading"><i class="fa-solid fa-lightbulb"></i> Hint</h3>
```

Vous pourrez trouvez des dizaines d‚Äôarticles et d‚Äôouvrages sur ce sujet dont chacun pr√©tend avoir trouv√© la meilleure organisation du travail (`Git flow`, `GitHub flow`, `GitLab flow`...). Ne lisez pas trop ces livres et articles sinon vous serez perdus (un peu comme avec les magazines destin√©s aux jeunes parents...).

La m√©thode de travail la plus simple est le *Github flow* qu'on vous a propos√© d'adopter. L'arborescence est reconnaissable : des branches divergent et reviennent syst√©matiquement vers `main`. 

Pour des projets plus complexes dans des √©quipes d√©veloppant des applications, on pourra utiliser d'autres m√©thodes de travail, notamment le `Git flow`. Il n'existe pas de r√®gles universelles pour d√©terminer la m√©thode de travail ; l'important c'est, avant tout, de se mettre d'accord sur des r√®gles communes de travail avec votre √©quipe.

```{=html}
</div>
```
:::

## M√©thode pour les merges

Les merges vers `main` doivent imp√©rativement passer par `Github` (ou `Gitlab`). Cela permet de garder une trace explicite de ceux-ci (par exemple [ici](https://github.com/linogaliana/python-datascientist/pulls?q=is%3Apr+is%3Aclosed)), sans avoir √† chercher dans l'arborescence, parfois complexe, d'un projet.

La bonne pratique veut qu'on fasse un `squash commit` pour √©viter une inflation du nombre de commits dans `main`: les branches ont vocation √† proposer une multitude de petits commits, les modifications dans `main` doivent √™tre simples √† tracer d'o√π le fait de modifier des petits bouts de code. 

Comme on l'a fait dans un exercice pr√©c√©dent, il est tr√®s pratique d‚Äôajouter dans le corps du message  `close #xx` o√π `xx` est le num√©ro d'une *issue* associ√©e √† la `pull request`. Lorsque la `pull request` sera fusionn√©e, l‚Äô*issue* sera automatiquement ferm√©e et un lien sera cr√©√© entre l'`issue` et la `pull request`. Cela vous permettra de comprendre, plusieurs mois ou ann√©es plus tard comment et pourquoi telle ou telle fonctionnalit√© a √©t√© impl√©ment√©e.

En revanche, l'int√©gration des derni√®res modifications de `main` vers une branche se fait en local. Si votre branche est en conflit, **le conflit doit √™tre r√©solu dans la branche et pas dans main**. 
`main` doit toujours rester propre. 

## Mise en pratique

::: {.cell .markdown}
```{=html}
<div class="alert alert-success" role="alert">
<h3 class="alert-heading"><i class="fa-solid fa-pencil"></i> Exercice 9 : Interactions avec le d√©p√¥t distant</h3>
```


Cet exercice se fait par groupe de trois ou quatre. Il y aura deux r√¥les dans ce sc√©nario :

- Une personne aura la responsabilit√© d'√™tre **mainteneur**
- Deux √† trois personnes seront **d√©veloppeurs**. 

1Ô∏è‚É£ Le mainteneur cr√©e un d√©p√¥t sur `Github`. Il/Elle donne des droits au(x) d√©veloppeur(s) du projet (`Settings > Manage Access > Invite a collaborator`).

2Ô∏è‚É£ Chaque membre du projet, cr√©e une copie locale du projet gr√¢ce √† la commande `git clone` ou
avec le bouton `Clone a repository` de `JupyterLab`.

Pour cela, r√©cup√©rer l'url HTTPS du d√©p√¥t en copiant l'url du d√©p√¥t que vous pouvez trouver, par exemple, dans la page d'accueil du d√©p√¥t, en dessous de `Quick setup ‚Äî if you‚Äôve done this kind of thing before`

En ligne de commande, cela donnera :

~~~shell
git clone https://github.com/<username>/<reponame>.git
~~~

3Ô∏è‚É£ Chaque membre du projet cr√©e un fichier avec son nom et son pr√©nom, selon cette structure `nom-prenom.md` en √©vitant les caract√®res sp√©ciaux. Il √©crit dedans trois phrases de son choix **sans ponctuation ni majuscules** (pour pouvoir effectuer une correction ult√©rieurement). Enfin, il commit sur le projet.

Pour rappel, en ligne de commande cela donnera les commandes suivantes √† modifier

~~~shell
git add nom-prenom.md
git commit -m "C'est l'histoire de XXXXX"
~~~

4Ô∏è‚É£ Chacun essaie d'envoyer (*push*) ses modifications locales sur le d√©p√¥t:

~~~shell
git push origin main
~~~


5Ô∏è‚É£ A ce stade, une seule personne (la plus rapide) devrait ne pas avoir rencontr√© de rejet du `push`. C'est normal, avant d'accepter une modification `Git` v√©rifie en premier lieu la coh√©rence de la branche avec le d√©p√¥t distant. Le premier ayant fait un `push` a modifi√© le d√©p√¥t commun ; les autres doivent int√©grer ces modifications dans leur version locale (*pull*) avant d'avoir le droit de proposer un  changement.

Pour celui/celle/ceux dont le `push` a √©t√© refus√©, faire

~~~shell
git pull origin main
~~~

pour ramener les modifications distantes en local. 

6Ô∏è‚É£ Taper `git log` et regarder la mani√®re dont a √©t√© int√©gr√© la modification de votre camarade ayant pu faire son `push`

Vous remarquerez que les commits de vos camarades sont int√©gr√©s tels quels √† 
l'histoire du d√©p√¥t. 

7Ô∏è‚É£ Faire √† nouveau 

~~~shell
git pull origin main
~~~

Le dernier doit refaire, √† nouveau, les √©tapes 5 √† 7 (dans une √©quipe de quatre
il faudra encore le refaire une fois).

```{=html}
</div>
```
:::

::: {.cell .markdown}
```{=html}
<div class="alert alert-danger" role="alert">
<i class="fa-solid fa-triangle-exclamation"></i> Warning √† nouveau: ne JAMAIS FAIRE <code>git push force</code></h3>
```

Quand on fait face √† un rejet du `push`, on est tent√© de faire passer en force le `push` malgr√© la mise en garde pr√©c√©dente.

Il faut **imm√©diatement oublier cette solution**, elle cr√©e de nombreux probl√®mes et, en fait, ne r√©sout rien. L'un des risques est de r√©√©crire enti√®rement l'historique rendant les copies locales, et donc les modifications de vos collaborateurs, caduques. Cela vous vaudra, √† raison, des remontrances de vos partenaires qui perdent le b√©n√©fice de leur historique `Git` qui, s'ils ont des versions sans `push` depuis longtemps peuvent avoir diverger fortement du d√©p√¥t ma√Ætre. 

```{=html}
</div>
```
:::


::: {.cell .markdown}
```{=html}
<div class="alert alert-success" role="alert">
<h3 class="alert-heading"><i class="fa-solid fa-pencil"></i> Exercice 10 : G√©rer les conflits quand on travaille sur le m√™me fichier</h3>
```

Dans la continuit√© de l'exercice pr√©c√©dent, chaque personne va travailler sur les fichiers des autres membres de l'√©quipe.

1Ô∏è‚É£ Les deux ou trois d√©veloppeurs ajoutent la ponctuation et les majuscules du fichier du premier d√©veloppeur.

2Ô∏è‚É£ Ils sautent une ligne et ajoutent une phrase (pas tous la m√™me).

3Ô∏è‚É£ Valider les r√©sultats (`git add .` et `commit`) et faire un `push`

4Ô∏è‚É£ La personne la plus rapide n'a, normalement, rencontr√© aucune difficult√© (elle peut s'arr√™ter temporairement pour regarder ce qui va se passer chez les voisins). Les autres voient leur `push` refus√© et doivent faire un `pull`. 

üí• Il y a conflit, ce qui doit √™tre signal√© par un message du type :

~~~shell
Auto-merging XXXXXX
CONFLICT (content): Merge conflict in XXXXXX.md
Automatic merge failed; fix conflicts and then commit the result.
~~~

5Ô∏è‚É£ Etudier le r√©sultat de `git status` 

6Ô∏è‚É£ Si vous ouvrez les fichiers incrimin√©s, vous devriez voir des balises du type

```{python}
#| output: asis
#| echo: false
print(
"""~~~markdown
<<<<<<< HEAD
this is some content to mess with
content to append
=======
totally different content to merge later
>>>>>>> new_branch_to_merge_later
~~~
"""
)
```

7Ô∏è‚É£ Corriger √† la main les fichiers en choisissant, pour chaque ligne, la version qui vous convient et en retirant les balises. Valider en faisant: 

~~~shell
git add . && git commit -m "R√©solution du conflit par XXXX"
~~~

Remplacer XXXX par votre nom. La balise `&&` permet d'encha√Æner, en une seule ligne de code, les deux commandes.

8Ô∏è‚É£ Faire un push. Pour la derni√®re personne, refaire les op√©rations 4 √† 8

```{=html}
</div>
```
:::
`Git` permet donc de travailler, en m√™me temps, sur le m√™me fichier et de limiter le nombre de gestes manuels n√©cessaires pour faire la fusion. Lorsqu'on travaille sur des bouts diff√©rents du m√™me fichier, on n'a m√™me pas besoin de faire de modification manuelle, la fusion peut √™tre automatique.

`Git` est un outil tr√®s puissant. Mais, il ne remplace pas une bonne organisation du travail. Vous l'avez vu, ce mode de travail uniquement sur `main` peut √™tre p√©nible. Les branches prennent tout leur sens dans ce cas. 

::: {.cell .markdown}
```{=html}
<div class="alert alert-success" role="alert">
<h3 class="alert-heading"><i class="fa-solid fa-pencil"></i> Exercice 11 : Gestion des branches</h3>
```

1Ô∏è‚É£ Le mainteneur va contribuer directement dans `main` et ne cr√©e pas de branche. Chaque d√©veloppeur cr√©e une branche, en local nomm√©e `contrib-XXXXX` o√π `XXXXX` est le pr√©nom: 

~~~shell
git checkout -b contrib-XXXXX
~~~

2Ô∏è‚É£ Chaque membre du groupe cr√©e un fichier `README.md` o√π il √©crit une phrase sujet-verbe-compl√©ment. Le mainteneur est le seul √† ajouter un titre dans le README (qu'il commit dans main).

3Ô∏è‚É£ Chacun push le produit de son subconscient sur le d√©p√¥t.

4Ô∏è‚É£ Les d√©veloppeurs ouvrent, chacun, une `pull request` sur `Github` de leur branche vers `main`. Ils lui donnent un titre explicite. 

5Ô∏è‚É£ Dans la discussion de chaque `pull request`, le mainteneur demande au d√©veloppeur d'int√©grer le titre qu'il a √©crit.  

6Ô∏è‚É£ Chaque d√©veloppeur, en local, int√®gre cette modification en faisant


```shell
# Pour √™tre s√ªr d'√™tre sur sa propre branche
git checkout branche-XXXX
git merge main
```

R√©gler le conflit et valider (`add` et `commit`). Pousser le r√©sultat. Le mainteneur choisit une des `pull request` et la valide avec l'option `squash commits`. V√©rifier sur la page d'accueil le r√©sultat.

7Ô∏è‚É£ L'auteur (si 2 d√©veloppeurs)  ou les deux auteurs (si 3 d√©veloppeurs) de la `pull request` non valid√©e doivent √† nouveau r√©p√©ter l'op√©ration 6. 

8Ô∏è‚É£ Une fois le conflit de version r√©gl√© et pouss√©, le mainteneur valide la `pull request` selon la m√™me proc√©dure que pr√©c√©demment. 

9Ô∏è‚É£ V√©rifier l'arborescence du d√©p√¥t dans `Insights > Network`. Votre arbre doit avoir une forme caract√©ristique de ce qu'on appelle le `Github flow`:

![](https://linogaliana.gitlab.io/collaboratif/pics/03_git/flow4_discuss.png)
```{=html}
</div>
```
:::
