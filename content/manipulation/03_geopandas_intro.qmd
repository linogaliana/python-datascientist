---
title: "Introduction aux données spatiales avec Geopandas"
tags:
  - geopandas
  - Velib
  - Tutoriel
  - Cartographie
  - Manipulation
categories:
  - Tutoriel
  - Manipulation
description: |
  Les données géolocalisées se sont multipliées depuis quelques années, qu'il
  s'agisse de données open-data ou de traces numériques géolocalisées de
  type _big-data_. Pour les données spatiales, le package `GeoPandas`
  étend les fonctionalités de l'écosystème `Pandas` afin de permettre
  de manipuler des données géographiques complexes de manière simple.
image: featured_geopandas_tutorial.png
echo: false
---

::: {.content-visible when-format="html"}
{{< include "../../build/_printBadges.qmd" >}}
:::

# Introduction

## Quelle différence avec des données traditionnelles ?

Les chapitres précédents ont permis de découvrir la manière 
dont des données structurées peuvent être valorisées
grâce à la librairie `Pandas`. Nous allons maintenant découvrir l'analyse
de données plus complexes, à savoir les données spatiales. 
Ces
dernières sont une sophistication des données tabulaires puisqu'en plus
de partager les propriétés de celles-ci (données aplaties dans une structure de colonnes et de lignes), elles comportent une dimension géographique supplémentaire. Celle-ci est plus ou moins complexe selon la nature des données: cela peut être des points (coordonnées de localisation en deux dimensions), des lignes (une suite de points), des lignes directionnelles (la même structure précédemment mais avec une direction), des polygones (un ensemble de points)... Cette diversité des objets géographiques vise à permettre des systèmes d'information et de représentation de nombreux objets géographiques.

Par la suite, nous entendrons par _"données spatiales"_ l'ensemble des données qui portent sur les caractéristiques géographiques des objets (localisation, contours, liens).
Les caractéristiques géographiques des objets sont décrites à l'aide d'un **système de coordonnées**. Celles-ci 
permettent de représenter l'objet géographique dans un espace euclidien à deux dimensions $(x,y)$.
Le passage de l'espace réel (la Terre, qui est une sphère en trois dimensions) à l'espace plan
se fait grâce à un **système de projection**. 

## Structure des données spatiales

Les données spatiales rassemblent classiquement deux types de données :

1. des **données géographiques** (ou géométries) : objets géométriques tels que des points, des vecteurs, des polygones, ou des maillages (*raster*). Exemple: la forme de chaque commune, les coordonnées d'un bâtiment;
2. des **données attributaires** (ou attributs) : des mesures et des caractéristiques associées aux objets géométriques. Exemple: la population de chaque commune, le nombre de fenêtres et le nombre d'étages d'un bâtiment.

**Les données spatiales sont fréquemment traitées à l'aide d'un système d'information géographique (SIG)**, c'est-à-dire un système d'information capable de stocker, d'organiser et de présenter des données alphanumériques spatialement référencées par des coordonnées dans un système de référence (CRS). `Python` dispose de fonctionnalités lui permettant de réaliser les mêmes tâches qu'un SIG (traitement de données spatiales, représentations cartographiques).

## Les données spatiales sont incontournables

D'un usage initialement essentiellement militaire ou administratif, la production cartographique est, depuis au moins le XIXe siècle, très fréquente
pour représenter de l'information socioéconomique. La représentation la plus connue dans ce domaine
est la carte par aplat de couleur, dite carte choroplèthe[^limite-choro]. 

D'après @chen2008brief, la première représentation de ce type 
a été proposée par Charles Dupin en 1926
pour représenter les niveaux d'instruction sur le territoire français. 
L'émergence des cartes choroplèthes est en effet indissociable 
de l'organisation du pouvoir sous forme d'entités pensées
politiques supposées unitaires:
les cartes du monde représentent souvent des aplats de couleurs à partir
des nations, les cartes nationales à partir d'échelons administratifs
(régions, départements, communes, mais aussi Etats ou _landers_). 

![La première carte choroplèthes par Dupin (1826)](https://upload.wikimedia.org/wikipedia/commons/thumb/3/38/Carte_figurative_de_l%27instruction_populaire_de_la_France.jpg/800px-Carte_figurative_de_l%27instruction_populaire_de_la_France.jpg){width="60%" fig-align="center"}.

[^limite-choro]: Malgré toutes ses limites, sur lesquelles nous reviendrons, la carte
choroplèthe est tout de même instructive. Savoir en produire une rapidement,
pour saisir les principaux faits structurants d'un jeu de données, est
particulièrement utile. 

Si la production d'information géographique a pu être très liée à un usage militaire puis à la gestion administrative d'un territoire, la
numérisation de l'économie ayant démultipliée les acteurs concernés par la collecte et la mise à disposition de données géographique, la manipulation et la représentation de données spatiales n'est plus l'apanage des géographes et géomaticiens. Les _data scientists_ doivent être capables de rapidement explorer la structure d'un jeu de données géographique comme ils le feraient d'un jeu de données tabulaires classiques. 

## Où trouver la donnée spatiale française ?

Lors de notre périple de découverte de `Pandas`,
nous avons déjà rencontré quelques sources géolocalisées,
notamment produites par l'Insee. Cette institution publie
de nombreuses statistiques locales, par exemple les données
Filosofi que nous avons rencontrées au chapitre précédent. Au-delà 
de l'Insee, l'ensemble des institutions du système
statistique public (Insee et services statistiques ministériels)
publie de nombreuses sources de données agrégées à différentes
mailles géographiques: à un niveau infracommunal (par exemple par [carreaux de 200m](https://www.insee.fr/fr/statistiques/6215138?sommaire=6215217)),
au niveau communal ou à des niveaux supracommunaux (zonages administratifs ou zonages d'études). 

Plus généralement, de nombreuses administrations françaises hors
du système statistique public diffusent des données
géographiques sur [data.gouv](https://www.data.gouv.fr/fr/). Nous avons par exemple précédemment exploité un jeu de données de l'Ademe dont la dimension géographique était la commune. 

L'acteur central de l'écosystème public de la donnée géographique est l'[IGN](https://www.ign.fr/). Bien connu des amateurs de randonnées pour ses cartes _"Top 25"_ qui peuvent être retrouvées sur le [geoportail](https://www.geoportail.gouv.fr/carte), l'IGN est également en charge de la cartographie des limites légales des entités administratives françaises (base AdminExpress), des forêts (BDForêt), des routes (BDRoute), des bâtiments (BDTopo), etc. Nous avons succinctement évoqué la librairie [`cartiflette`](https://github.com/InseeFrLab/cartiflette) lors du chapitre précédent, qui permet de récupérer les fonds de carte administratifs (base AdminExpress) de manière flexible avec `Python` ; nous irons plus loin dans ce chapitre. 

La puissance publique n'est plus l'unique acteur qui produit et diffuse de la donnée spatiale. La collecte de coordonnées GPS étant devenue presque automatique, de nombreux acteurs collectent, exploitent et même revendent de la donnée spatiale sur leurs utilisateurs. Ces données peuvent être très précises et très riches sur certaines problématiques, par exemple sur les déplacements. Il est néanmoins nécessaire d'avoir à l'esprit lorsqu'on désire
extrapoler des statistiques construites sur ces données que celles-ci concernent les utilisateurs du service en question, qui ne sont pas nécessairement représentatifs des comportements de la population dans son ensemble.

## Données utilisées dans ce chapitre

Dans ce tutoriel, nous allons utiliser les données suivantes :

* [Localisations des stations velib](https://opendata.paris.fr/explore/dataset/velib-emplacement-des-stations/download/?format=geojson&timezone=Europe/Berlin&lang=fr) ;
* [fonds de carte `AdminExpress`](https://geoservices.ign.fr/adminexpress) à
travers un package `Python` nommé [`cartiflette`](https://github.com/InseeFrLab/cartiflette)
facilitant la récupération de cette source. 

## Installations préalables

```{python}
#| output : false 
#| echo: true
# à faire obligatoirement en premier pour utiliser rtree ou pygeos pour les jointures spatiales
!pip install pandas fiona shapely pyproj rtree 
!pip install contextily
!pip install geopandas
!pip install topojson
```

Pour être en mesure d'exécuter ce tutoriel, les imports suivants
seront utiles.

```{python}
#| output: false
#| echo: true
import geopandas as gpd
import contextily as ctx
import matplotlib.pyplot as plt
```

::: {.cell .markdown}
```{=html}
<div class="alert alert-info" role="alert">
<h3 class="alert-heading"><i class="fa-solid fa-comment"></i> Note</h3>
```

Le package `cartiflette` est expérimental 
et n'est disponible que sur
[`Github`](https://github.com/InseeFrLab/cartogether), pas sur `PyPi`.
Il est amené à évoluer rapidement et cette page sera mise à jour
quand de nouvelles fonctionalités (notamment l'utilisation d'`API`)
seront disponibles pour encore simplifier la récupération de
contours géographiques.

```{=html}
</div>
```
:::


Pour installer `cartiflette`, il est nécessaire d'utiliser les commandes suivantes
depuis un `Jupyter Notebook` (si vous utilisez la ligne de commande directement,
vous pouvez retirer les `!` en début de ligne):

```{python}
#| eval: false
#| echo: true
!pip install py7zr geopandas openpyxl tqdm s3fs
!pip install PyYAML xlrd
!pip install git+https://github.com/inseefrlab/cartiflette
```



# De `Pandas` à `Geopandas`

Le *package* `Geopandas` est une boîte à outils conçue pour faciliter la manipulation de données spatiales. **La grande force de `Geopandas` est qu'il permet de manipuler des données spatiales comme s'il s'agissait de données traditionnelles**, car il repose sur le standard ISO 19125 [*simple feature access*](https://en.wikipedia.org/wiki/Simple_Features) défini conjointement par l'*Open Geospatial Consortium (OGC)* et l'*International Organization for Standardization (ISO)*. `Geopandas` repose d'une part sur `Pandas` pour le traitement de la dimension tabulaire des données spatiales et d'autre part sur [`Shapely`](https://shapely.readthedocs.io/en/stable/manual.html) et [`GDAL`](https://gdal.org/index.html) pour les manipulations géométriques. Néanmoins, comme `Pandas` permettait de faire du `Numpy` sans le savoir, lorsqu'on travaille avec `Geopandas` on repose sur les deux couches basses que sont `Shapely` et `GDAL` sans avoir à s'embêter. 

Par rapport à un _DataFrame_ standard, un objet `Geopandas` comporte
une colonne supplémentaire: `geometry`. Elle stocke les coordonnées des
objets géographiques (ou ensemble de coordonnées s'agissant de contours). Un objet `Geopandas` hérite des propriétés d'un 
_DataFrame_ `Pandas` mais propose des méthodes adaptées au traitement des données spatiales. Par conséquent, grâce à `GeoPandas`, on a des attributs qui reposent sur le principe de données _tidy_ évoquées dans le [chapitre précédent](content/manipulation/02_pandas_intro.qmd) alors que la géométrie afférante sera gérée de manière cohérente en parallèle des attributs. 

Ainsi, grâce à  `Geopandas`, on pourra effectuer des manipulations sur les attributs des données comme avec `pandas` mais on pourra également faire des manipulations sur la dimension spatiale des données. En particulier,

* Calculer des distances et des surfaces ;
* Agréger rapidement des zonages (regrouper les communes en département par exemple) ;
* Trouver dans quelle commune se trouve un bâtiment à partir de ses coordonnées géographiques ;
* Recalculer des coordonnées dans un autre système de projection ;
* Faire une carte, rapidement et simplement.

::: {.cell .markdown}
```{=html}
<div class="alert alert-warning" role="alert">
<h3 class="alert-heading"><i class="fa-solid fa-lightbulb"></i> Hint</h3>
```

Les manipulations de données sur un objet `Geopandas` sont nettement plus lentes que sur
un `DataFrame` traditionnel (car `Python` doit gérer les informations géographiques pendant la manipulation des données).
Lorsque vous manipulez des données de grandes dimensions,
il peut être préférable d’effectuer les opérations sur les données avant de joindre une géométrie à celles-ci.

```{=html}
</div>
```
:::

Par rapport à un logiciel spécialisé comme `QGIS`, `Python` permettra 
d'automatiser le traitement et la représentation des données. D'ailleurs,
`QGIS` utilise lui-même `Python`...

## Anatomie d'un objet `GeoPandas`

En résumé, un objet `GeoPandas` comporte les éléments suivantes :

![](https://rgeo.linogaliana.fr/slides/img/sf.png)

1. Les __attributs__. Ce sont les valeurs associées à chaque niveau géographique. 
Il s'agit de la dimension tabulaire usuelle, dont le traitement est similaire
à celui d'un objet `Pandas` classique. 
2. Les __géométries__. Ce sont les valeurs numériques interprétées pour représenter la dimension géographique. Elles permettent de représenter dans un certain
référentiel (le système de référence) la dimension géographique. 
3. Le __système de référence__. Il s'agit du système permettant de transformer les positions sur
le globe (3 dimensions avec une boule asymétrique) en un plan en deux dimensions. 
Il en existe une multitude, identifiables à partir d'un code EPSG (4326, 2154...). 
Leur manipulation est facilitée par `Geopandas` qui s'appuie sur `Shapely`, de la même
manière que `Pandas` s'appuie sur `Numpy` ou `Arrow`. 

## Objectifs de ce chapitre

Ce chapitre illustre à partir d’exemples pratiques certains principes centraux de l’analyse de données :

- Manipulations sur les attributs des jeux de données ;
- Manipulations géométriques ;
- Gestion des projections cartographiques ;
- Création rapide de cartes (ce sera approfondi dans un prochain chapitre).


::: {.cell .markdown}

```{=html}
<div class="alert alert-info" role="alert">
<h3 class="alert-heading"><i class="fa-solid fa-comment"></i> Note</h3>
```

Si vous êtes intéressés par `R` et le package `sf`,
une version très proche de ce TP est
disponible dans [ce cours](https://rgeo.linogaliana.fr/exercises/geospatial-wrangling.html).

```{=html}
</div>
```

:::

# Lire et enrichir des données spatiales

Dans le chapitre précédent, nous avons évoqué les formats de données
plats comme le `CSV` ou les nouveaux formats comme `Parquet`. Ceux-ci
sont adaptés à des données tabulaires. 
Pour des données géographiques,
qui stockent de l'information selon plusieurs dimensions (les attributs
et la géométrie), il existe des formats spécialisés. 

## Le _shapefile_

Le format historique est le _[shapefile](https://fr.wikipedia.org/wiki/Shapefile)_. Dans ce format, la donnée est stockée dans plusieurs fichiers: 

- `data.shp` : contient les géométries des entités spatiales (points, lignes, polygones...).
- `data.shx` : un index pour accéder rapidement aux géométries stockées dans le fichier `.shp`.
- `data.dbf` : une table attributaire au format dBase qui contient les informations descriptives des entités spatiales.
- `data.prj` : contient les informations de projection et de système de coordonnées (nous reviendrons sur ce concept ultérieurement).

Ce format présente plusieurs inconvénients. Tout d'abord il est assez lourd et certains formats modernes seront plus optimisés pour réduire la volumétrie et le temps de chargement des données. Surtout, son problème principal est que pour lire les données de manière intègre, il est nécessaire de partager de manière systématique ces quatre fichiers, sous peine d'introduire un risque de corruption ou d'incomplétude de la donnée.

Le format `GeoPackage` est un héritier spirituel du _shapefile_ visant à résoudre ces deux limites du format précédent. Les géomaticiens apprécient ce format mais il est moins connu par les _data scientists_ que le _shapefile_ ou que le `geojson` que nous allons décrire. 


## Le GeoJSON et le TopoJSON

Le développement d'un format concurrent l'hégémonie du _shapefile_ est intrinsèquement lié à l'émergence des technologies _web_ dans le secteur de la cartographie. Ces technologies web s'appuient sur Javascript et reposent sur les standards du format JSON. 

Le format GeoJSON stocke dans un seul fichier à la fois les attributs et les géométries. Il est donc assez pratique à l'usage et s'est imposé comme le format préféré des développeurs web. Le fait de stocker l'ensemble de l'information dans un seul fichier peut cependant le rendre assez volumineux si les géométries sont très précises. `GeoPandas` est très bien fait pour lire des fichiers au format GeoJSON et les plateformes de partage de données, comme `data.gouv` privilégient ce format à celui du _shapefile_. 

Pour alléger le fichier, le format `TopoJSON` a récémment émergé. Celui-ci est construit selon les mêmes principes que le `GeoJSON` mais réduit le volume de données géométriques stockées en ne conservant pas tous les points mais en appliquant une simplification pour ne conserver que les arcs et les directions entre ceux-ci. Ce format étant récent, il n'est pas encore bien intégré à l'écosystème `Python`.

## Les autres formats de données

L'écosystème des formats de données géographiques est bien plus éclaté que celui des données structurées. Chaque format présente des avantages qui le rendent intéressant pour un type de données mais des limites qui l'empêchent de devenir un standard pour d'autres types de données. 

Par exemple, les données GPS extraites de diverses applications (par exemple `Strava`) sont stockées au format GPX. Ce dernier est particulièrement adapté pour des traces géolocalisées avec une altitude. Mais ce n'est pas le format le plus approprié pour stocker des lignes directionnelles, un prérequis indispensable pour les applications d'itinéraires. 

Les formats _shapefile_ et _geojson_ sont suffisamment malléables pour s'adapter aux différents types de données géographiques même s'il ne s'agit
pas du format optimal pour tel ou tel type de données. Dans cette classe généraliste de formats, le `Geoparquet` pourrait être le prochain format à la mode. Comme son nom l'indique, il s'agit d'une extension du format `Parquet` à des données géographiques. Ce format n'est pas encore mûr mais reste à suivre, la masse d'utilisateurs de l'écosystème `Parquet` pouvant amener à un changement rapide si une implémentation stable de `Geoparquet`  émerge. 

## Exercice de découverte

L'objectif de cet exercice est d'illustrer la similarité des objets
`GeoPandas` avec les objets `Pandas` que nous avons découverts précédemment. 

Nous allons importer directement les données `AdminExpress` (limites officielles des communes produites par l'IGN) avec `cartiflette`:

```{python}
#| echo: true
from cartiflette import carti_download
```

::: {.cell .markdown}
```{=html}
<div class="alert alert-success" role="alert">
<h3 class="alert-heading"><i class="fa-solid fa-pencil"></i> Exercice 1: découverte des objets géographiques</h3>
```

En premier lieu, on récupère des données géographiques grâce
au _package_ `cartiflette` et à sa fonction `carti_download`.

1. Utiliser
le code ci-dessous pour
télécharger les données communales (produit `Admin Express` de l'IGN)
des départements de la petite couronne (75, 92, 93 et 94)
de manière simplifiée grâce au _package_
`cartiflette`:

```{python}
#| echo: true
#| output: false
communes_borders = carti_download(
    crs = 4326,
    values = ["75", "92", "93", "94"],
    borders="COMMUNE",
    vectorfile_format="geojson",
    filter_by="DEPARTEMENT",
    source="EXPRESS-COG-CARTO-TERRITOIRE",
    year=2022)
```

2. Regarder les premières lignes des données. Identifier la différence avec
un _dataframe_ standard. 

3. Afficher le `crs` de `communes_borders`. Ce dernier contrôle la
transformation de l'espace tridimensionnel terrestre en une surface plane.
Utiliser `to_crs` pour transformer les données en Lambert 93, le 
système officiel (code EPSG 2154). 

4. Afficher les communes des Hauts de Seine (département 92) et utiliser la méthode
`plot`

5. Ne conserver que Paris et réprésenter les frontières sur une carte : quel est le problème pour
une analyse de Paris intramuros?

On remarque rapidement le problème. 
On ne dispose ainsi pas des limites des arrondissements parisiens, ce
qui appauvrit grandement la carte de Paris. 

6. Cette fois, utiliser l'argument `borders="COMMUNE_ARRONDISSEMENT"` pour obtenir
un fonds de carte consolidé des communes avec les arrondissements dans les grandes villes. 
Convertir en Lambert 93. 

```{=html}
</div>
```
:::


```{python}
#| output: false

# 1. Chargement des données de Cartiflette
communes_borders = carti_download(
    crs = 4326,
    values = ["75", "92", "93", "94"],
    borders="COMMUNE",
    vectorfile_format="geojson",
    filter_by="DEPARTEMENT",
    source="EXPRESS-COG-CARTO-TERRITOIRE",
    year=2022)
```

La visualisation proposée à la question permet de voir que notre _DataFrame_ 
comporte la colonne _geometry_ qui contient les informations nécessaires pour connaître les contours communaux

```{python}
#| output: false
# 2. Regarder les premières lignes
communes_borders.head()
```

```{python}
#| output: false

# 3) Afficher le crs
communes_borders.crs
# Les données sont en WGS84, on les reprojette en Lambert 93
```

```{python}
#| echo: false

# 4) afficher les communes du département 92
ax = communes_borders[communes_borders['INSEE_DEP'] == "92"].boundary.plot()
ax.set_axis_off()
```

A la question 5, on remarque facilement le problème pour Paris:
il manque les limites des arrondissements. 
Cela appauvrit grandement la carte de Paris. 

```{python}
#| echo: false

# 5) Représenter la carte de Paris. Quel est le problème ?
ax = communes_borders[communes_borders['INSEE_DEP'] == "75"].boundary.plot()
ax.set_axis_off()
```

A l'issue de la question 6, on obtient la carte attendue pour
Paris intramuros:

```{python}
#| output: false

# 6. Chargement des données de Cartiflette
petite_couronne = carti_download(
    crs = 4326,
    values = ["75", "92", "93", "94"],
    borders="COMMUNE_ARRONDISSEMENT",
    vectorfile_format="geojson",
    filter_by="DEPARTEMENT",
    source="EXPRESS-COG-CARTO-TERRITOIRE",
    year=2022)
    
petite_couronne.crs
petite_couronne = petite_couronne.to_crs(2154)
petite_couronne.crs
```

```{python}
ax = petite_couronne[petite_couronne['INSEE_DEP'] == "75"].boundary.plot()
ax.set_axis_off()
```

# Le système de projection cartographique

## Principe

Les données spatiales sont
plus riches que les données traditionnelles car elles
incluent, habituellement, des éléments supplémentaires pour placer dans
un espace cartésien les objets. Cette dimension supplémentaire peut être simple
(un point comporte deux informations supplémentaire: $x$ et $y$) ou
assez complexe (polygones, lignes avec direction, etc.).

L'analyse cartographique emprunte dès lors à la géométrie
des concepts
pour représenter des objets dans l'espace. Les __projections__
sont au coeur de la gestion des données spatiales. 
Ces dernières consistent à transformer une position dans l'espace
terrestre à une position sur un plan. Il s'agit donc d'une opération
de projection d'un espace tri-dimensionnel dans un espace
à deux dimensions. 
Ce [post](https://www.earthdatascience.org/courses/earth-analytics/spatial-data-r/geographic-vs-projected-coordinate-reference-systems-UTM/) propose de riches éléments sur le
sujet, notamment l'image suivante qui montre bien le principe d'une projection :

![Les différents types de projection](https://www.earthdatascience.org/images/courses/earth-analytics/spatial-data/spatial-projection-transformations-crs.png)


Cette opération n'est pas neutre. L'une des conséquences du
[théorème remarquable de Gauss](https://fr.wikipedia.org/wiki/Theorema_egregium)
est que la surface de la Terre ne peut être cartographiée sans distortion.
Une projection ne peut simultanément conserver intactes les distances et les 
angles (i.e. les positions). 
Il n'existe ainsi pas de projection universellement meilleure, ce qui ouvre
la porte à la coexistence de nombreuses projections différentes, pensées
pour des tâches différentes. 
Un mauvais système de représentation
fausse l'appréciation visuelle mais peut aussi entraîner des erreurs dans
les calculs sur la dimension spatiale.

**Les systèmes de projection font l'objet de standards internationaux et sont souvent désignés par des codes dits codes EPSG**. Ce [site](https://epsg.io/) est un bon aide-mémoire. Les plus fréquents, pour les utilisateurs français, sont les suivants (plus d'infos [ici](https://geodesie.ign.fr/contenu/fichiers/documentation/SRCfrance.pdf)) :

* `2154` : système de projection Lambert 93. Il s'agit du système de projection officiel. La plupart des données diffusées par l'administration pour la métropole sont disponibles dans ce système de projection. 
* `27572` : Lambert II étendu. Il s'agit de l'ancien système de projection officiel. Les données spatiales anciennes peuvent être dans ce format.
* `4326` : WGS 84 ou système de pseudo-Mercator ou encore _Web Mercator_. Ce n'est en réalité pas un système de projection mais un système de coordonnées (longitude / latitude) qui permet simplement un repérage angulaire sur l'ellipsoïde. Il est utilisé pour les données GPS. Il s'agit du système le plus
usuel, notamment quand on travaille avec des fonds de carte _web_.


Comme évoqué plus haut, l'une des projections les plus connues est la
projection _Web Mercator_ dite WGS84 (code EPSG 4326). Il 
s'agit d'une projection conservant intacte les angles, ce
qui implique qu'elle altère les distances. Celle-ci a en effet été
pensée, à l'origine, pour représenter l'hémisphère Nord. Plus
on s'éloigne de celui-ci, plus les distances sont distordues. Cela
amène à des distorsions bien
connues (le Groenland hypertrophié, l'Afrique de taille réduite, l'Antarctique démesuré...).
En revanche, la projection Mercator conserve intacte les positions. 
C'est cette propriété qui explique son utilisation dans les systèmes
GPS et ainsi dans les fonds de carte de navigation du type _Google Maps_. 
Il s'agit d'une projection pensée d'abord pour la navigation, non pour la représentation d'informations socioéconomiques sur la terre. Cette projection est indissociable des grandes explorations de la Renaissance, comme le rappelle [ce fil](https://x.com/JulesGrandin/status/1765668642094514447) sur Twitter de Jules Grandin.

![*Exemple de reprojection de pays depuis le site [thetruesize.com](https://thetruesize.com/)*](https://minio.lab.sspcloud.fr/lgaliana/generative-art/pythonds/truesize.png)


::: {.content-visible when-format="html"}

Observez les variations significatives
de proportions pour certains pays selon les projections
choisies:

```{ojs}
//| echo: false
html`<div>${container_projection}</div>`
``` 

{{< include "_play_with_projection.qmd" >}}

```{ojs}
//| echo: false
width_projected_map = screen.width/2
```

:::

Pour aller plus loin, la carte interactive
suivante, construite par Nicolas Lambert, issue de
ce [_notebook_ `Observable`](https://observablehq.com/@neocartocnrs/impact-of-projections-on-areas), illustre l'effet
déformant de la projection Mercator, et de quelques-unes autres,
sur notre perception de la taille des pays.

::: {.content-visible when-format="html"}

<details>
<summary>
Voir la carte interactive
</summary>
```{ojs}
//| echo: false
html`<div class="grid-container">
  <div class="viewof-projection">${viewof projectionBertin}</div>
  <div class="viewof-mycountry">${viewof mycountry}</div>
  <div class="map-bertin">${mapBertin}</div>
</div>`
```

</details>

```{ojs}
//| echo: false
import {map as mapBertin, viewof projection as projectionBertin, viewof mycountry} from "@neocartocnrs/impact-of-projections-on-areas"
```

:::


Il existe en fait de nombreuses représentations possibles du monde, plus ou moins 
alambiquées. Les projections sont très nombreuses et certaines peuvent avoir une [forme suprenante](https://imgs.xkcd.com/comics/map_projections.png).
Par exemple,
la [projection de Spillhaus](https://storymaps.arcgis.com/stories/756bcae18d304a1eac140f19f4d5cb3d)
propose de centrer la vue sur les océans et non une terre. C'est pour
cette raison qu'on parle parfois de monde tel que vu par les poissons
à son propos. 

::: {.content-visible when-format="html"}

```{ojs}
//| echo: false
html`<div class="centered">${spilhaus}</div>`
```


```{ojs}
//| echo: false
//| fig-align: center
spilhaus = {
  const width = 600;
  const height = width;

  const context = DOM.context2d(width, height);
  const projection = d3.geoStereographic()
    .rotate([95, 45])
    .translate([width / 2, height / 2])
    .scale(width / 10.1)
    .center([30, -5])
    .clipAngle(166);
  const path = d3.geoPath(projection, context);

  const land = topojson.feature(world, world.objects.land);

  context.lineJoin = "round";
  context.lineCap = "round";
  context.fillStyle = "#f2f1ed";
  context.fillRect(0, 0, width, height);

  context.beginPath();
  path({type: "Sphere"});
  path(land);
  context.lineWidth = 0.5;
  context.stroke();
  context.clip("evenodd");

  context.save();
  context.beginPath();
  path(land);
  context.filter = "blur(12px)";
  context.fillStyle = "#006994";
  context.fill("evenodd");
  context.restore();
  
  context.beginPath();
  path(d3.geoGraticule10());
  context.globalAlpha = 0.2;
  context.strokeStyle = "#000";
  context.stroke();

  return context.canvas;
}
```


```{ojs}
//| echo: false
//import {map as spilhausmap} with {height, width} from "@d3/spilhaus-shoreline-map"
import { world } from "@d3/spilhaus-shoreline-map"
```

:::

::: {.cell .markdown}
```{=html}
<div class="alert alert-info" role="alert">
<h3 class="alert-heading"><i class="fa-solid fa-comment"></i> Astuce pour la France</h3>
```

Pour la France, dans le système WGS84 (4326) :

- Longitude ($x$) tourne autour de 0° (de -5.2 à +9.6 pour être plus précis)
- La latitude  ($y$) autour de 45 (entre +41.3 à +51.1)

Dans le système Lambert 93 (2154) :

- Coordonnées $x$:  entre 100 000 et 1 300 000
- La latitude  ($y$): entre 6 000 000 et 7 200 000

[Plus de détails](https://medium.com/@_FrancoisM/introduction-%C3%A0-la-manipulation-de-donn%C3%A9es-cartographiques-23b4e38d8f0f)

```{=html}
</div>
```
:::
